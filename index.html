<!DOCTYPE html>
<html>
  <head>
    <title>dxf-to-ggb-converter</title>
  </head>
  <body>
    <script
      src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"
      type="text/javascript"
    ></script>
    <script
      src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"
      type="text/javascript"
    ></script>
    <script
      src="https://unpkg.com/dxf-parser@1.1.2/dist/dxf-parser.js"
      type="text/javascript"
    ></script>

    <input id="inputfile" type="file" name="inputfile" />
    <br />
    <pre id="output"></pre>

    <script>
      let fileName = "test";

      // add listener for file input
      let fileInputElement = document.getElementById("inputfile");
      fileInputElement.addEventListener("change", function () {
        let inputReader = new FileReader();
        let file = this.files[0];
        fileName = file.name;
        inputReader.onload = function () {
          processFile(inputReader);
        };
        inputReader.readAsText(file);
      });

      // process file
      function processFile(inputReader) {
        // parse dxf file
        let dxfContent = inputReader.result;
        const parser = new DxfParser();
        try {
          let dxf = parser.parseSync(dxfContent);
          extractXmlFromDxf(dxf);
        } catch (err) {
          document.getElementById("output").textContent =
            "ERROR: Something is wrong with the provided dxf file!\n" +
            err.stack;
          console.error(err.stack);
        }
      }

      function extractXmlFromDxf(dxf) {
        // for Debug
        let dxfToJson = JSON.stringify(dxf, null, 2);
        document.getElementById("output").textContent = dxfToJson;

        // TODO

        let ggbContent = "TODO add elements and commands\n";
        // saveToGGB(ggbContent); // TODO uncomment later!
      }

      // output file to the download folder
      function saveToGGB(ggbContent) {
        // start zip creation
        let zip = new JSZip();
        // create an empty geogebra.xml file
        // and add the elements and commands from the ggbContent
        let xmlHeader = '<?xml version="1.0" encoding="utf-8"?>\n';
        let ggbHeader =
          '<geogebra format="5.0" >\n' +
          '<construction title="" author="" date="">\n';
        let ggbFooter = "</construction>\n" + "</geogebra>\n";
        zip.file(
          "geogebra.xml",
          xmlHeader + ggbHeader + ggbContent + ggbFooter
        );
        // save as ziped ggb file
        zip.generateAsync({ type: "blob" }).then(function (content) {
          saveAs(content, fileName + ".ggb");
        });
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <title>dxf-to-ggb-converter</title>
  </head>
  <body>
    <script
      src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"
      type="text/javascript"
    ></script>
    <script
      src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"
      type="text/javascript"
    ></script>
    <script
      src="https://unpkg.com/dxf-parser@1.1.2/dist/dxf-parser.js"
      type="text/javascript"
    ></script>

    <input id="inputfile" type="file" name="inputfile" />
    <br />
    <pre id="output"></pre>

    <script>
      "use strict";

      let fileName = "test";

      // add listener for file input
      let fileInputElement = document.getElementById("inputfile");
      fileInputElement.addEventListener("change", function () {
        let inputReader = new FileReader();
        let file = this.files[0];
        fileName = file.name;
        inputReader.onload = function () {
          processFile(inputReader);
        };
        inputReader.readAsText(file);
      });

      // process file
      function processFile(inputReader) {
        // parse dxf file
        let dxfContent = inputReader.result;
        const parser = new DxfParser();
        try {
          let dxf = parser.parseSync(dxfContent);
          extractXmlFromDxf(dxf);
        } catch (err) {
          document.getElementById("output").textContent =
            "ERROR: Something might be wrong with the provided dxf file!\n\n" +
            err.name +
            ", " +
            err.message +
            ": \n" +
            err.stack;
        }
      }

      function extractXmlFromDxf(dxf) {
        // COMMENT mark exists?  1xxx = yes, 9xxx = no
        let pointTypesMap = {
          1000: "allgemeine Marke",
          1200: "Rohr",
          1120: "Unbehauener Feldstein",
          1110: "Grenzstein",
          1650: "Klebemarke",
          1500: "Pfahl",
          1655: "Schlagmarke",
          1400: "MeiÃŸelzeichen",
          1300: "Nagel",
          9500: "ohne Marke",
          9998: "Nach Quellangaben nicht zu spezifizieren",
          9600: "Abmarkung zeitweilig ausgesetzt",
        };

        let usedLayers = new Set();

        let points = {};
        let lines = {};
        let texts = {};

        let additionalInfos = {};
        const blocks = dxf.blocks;
        for (const key in blocks) {
          let block = blocks[key];
          additionalInfos[block.name] = {};
          additionalInfos[block.name].layer = block.layer;
          additionalInfos[block.name].comment = block.name2;
        }
        let entities = dxf.entities;
        for (const entity of entities) {
          usedLayers.add(
            entity.type +
              " " +
              entity.layer +
              (entity.name ? " " + entity.name : "")
          );

          let key;
          switch (entity.type) {
            case "INSERT":
              key = "P" + entity.handle;
              points[key] = {};
              points[key].layer = entity.layer;
              points[key].x = entity.position.x;
              points[key].y = entity.position.y;
              points[key].type = pointTypesMap[entity.name.replace("ABM_", "")];
              const info = additionalInfos[entity.name];
              if (info.layer == entity.layer) {
                points[key].comment = info.comment;
              }
              break;
            case "LINE":
            case "LWPOLYLINE":
              key = "L" + entity.handle;
              lines[key] = {};
              lines[key].layer = entity.layer;
              lines[key].vertices = entity.vertices;
              break;
            case "TEXT":
              key = "T" + entity.handle;
              texts[key] = {};
              texts[key].layer = entity.layer;
              texts[key].x = entity.startPoint.x;
              texts[key].y = entity.startPoint.y;
              texts[key].text = entity.text;
              break;
            default:
              break;
          }
        }
        // TODO find and add node handles for lines and polylines

        // TODO show used layers and
        // TODO add an option to select wanted ones
        // 1. add an html element for each and provide an option to remove each one
        // 2. provide an option to asign point/line/text types
        //    (and duplicate policies -> nichtfestgestellteGrenze line stays; flurstueck line is removed)
        // 3. collect the remaining ones afterwards
        // TODO remove duplicate lines

        // TODO add an option to move all points by two values towards the origin (0, 0)

        // TODO create the xml ggbContent from the maps above

        // for Debug
        let dxfToJson =
          "\n\n-------------------------------------------------------\n\n" +
          JSON.stringify(Array.from(usedLayers).sort(), null, 2) +
          "\n\n-------------------------------------------------------\n\n" +
          JSON.stringify(points, null, 2) +
          "\n\n-------------------------------------------------------\n\n" +
          JSON.stringify(lines, null, 2) +
          "\n\n-------------------------------------------------------\n\n" +
          JSON.stringify(texts, null, 2);
        document.getElementById("output").textContent = dxfToJson;

        let ggbContent = "TODO add elements and commands\n";
        // saveToGGB(ggbContent); // TODO uncomment later!
      }

      // output file to the download folder
      function saveToGGB(ggbContent) {
        // start zip creation
        let zip = new JSZip();
        // create an empty geogebra.xml file
        // and add the elements and commands from the ggbContent
        let xmlHeader = '<?xml version="1.0" encoding="utf-8"?>\n';
        let ggbHeader =
          '<geogebra format="5.0" >\n' +
          '<construction title="" author="" date="">\n';
        let ggbFooter = "</construction>\n" + "</geogebra>\n";
        zip.file(
          "geogebra.xml",
          xmlHeader + ggbHeader + ggbContent + ggbFooter
        );
        // save as ziped ggb file
        zip.generateAsync({ type: "blob" }).then(function (content) {
          saveAs(content, fileName + ".ggb");
        });
      }
    </script>
  </body>
</html>

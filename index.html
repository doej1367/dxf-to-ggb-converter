<!DOCTYPE html>
<html>
  <head>
    <title>dxf-to-ggb-converter</title>
  </head>
  <body>
    <script
      src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"
      type="text/javascript"
    ></script>
    <script
      src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"
      type="text/javascript"
    ></script>
    <script
      src="https://unpkg.com/dxf-parser@1.1.2/dist/dxf-parser.js"
      type="text/javascript"
    ></script>

    <input id="inputfile" type="file" name="inputfile" />
    <br />
    <pre id="output"></pre>

    <script>
      "use strict";

      let fileName = "test";

      // add listener for file input
      let fileInputElement = document.getElementById("inputfile");
      fileInputElement.addEventListener("change", function () {
        let inputReader = new FileReader();
        let file = this.files[0];
        fileName = file.name;
        inputReader.onload = function () {
          processFile(inputReader);
        };
        inputReader.readAsText(file);
      });

      // process file
      function processFile(inputReader) {
        // parse dxf file
        let dxfContent = inputReader.result;
        const parser = new DxfParser();
        try {
          let dxf = parser.parseSync(dxfContent);
          extractXmlFromDxf(dxf);
        } catch (err) {
          document.getElementById("output").textContent =
            "ERROR: Something might be wrong with the provided dxf file!\n\n" +
            err.name +
            ", " +
            err.message +
            ": \n" +
            err.stack;
          console.error(err.stack);
        }
      }

      function extractXmlFromDxf(dxf) {
        let points = {};
        let lines = {};
        let texts = {};

        let additionalInfos = {};
        const blocks = dxf.blocks;
        for (const key in blocks) {
          let block = blocks[key];
          console.log(block);
          additionalInfos[block.name] = {};
          additionalInfos[block.name].layer = block.layer;
          additionalInfos[block.name].comment = block.name2;
        }
        let entities = dxf.entities;
        for (const entity of entities) {
          switch (entity.type) {
            case "INSERT":
              points[entity.handle] = {};
              points[entity.handle].layer = entity.layer;
              points[entity.handle].x = entity.position.x;
              points[entity.handle].y = entity.position.y;
              const info = additionalInfos[entity.name];
              if (info.layer == entity.layer) {
                points[entity.handle].comment = info.comment;
              }
              break;
            case "LINE":
              lines[entity.handle] = {};
              lines[entity.handle].layer = entity.layer;
              lines[entity.handle].x1 = entity.vertices[0].x;
              lines[entity.handle].y1 = entity.vertices[0].y;
              lines[entity.handle].x2 = entity.vertices[1].x;
              lines[entity.handle].y2 = entity.vertices[1].y;
              break;
            case "TEXT":
              texts[entity.handle] = {};
              texts[entity.handle].layer = entity.layer;
              texts[entity.handle].x = entity.startPoint.x;
              texts[entity.handle].y = entity.startPoint.y;
              texts[entity.handle].text = entity.text;
              break;
            default:
              break;
          }
        }
        // TODO find and add start and end node handles for lines

        // for Debug
        let dxfToJson =
          JSON.stringify(points, null, 2) +
          "\n\n" +
          JSON.stringify(lines, null, 2) +
          "\n\n" +
          JSON.stringify(texts, null, 2);
        document.getElementById("output").textContent = dxfToJson;

        let ggbContent = "TODO add elements and commands\n";
        // saveToGGB(ggbContent); // TODO uncomment later!
      }

      // output file to the download folder
      function saveToGGB(ggbContent) {
        // start zip creation
        let zip = new JSZip();
        // create an empty geogebra.xml file
        // and add the elements and commands from the ggbContent
        let xmlHeader = '<?xml version="1.0" encoding="utf-8"?>\n';
        let ggbHeader =
          '<geogebra format="5.0" >\n' +
          '<construction title="" author="" date="">\n';
        let ggbFooter = "</construction>\n" + "</geogebra>\n";
        zip.file(
          "geogebra.xml",
          xmlHeader + ggbHeader + ggbContent + ggbFooter
        );
        // save as ziped ggb file
        zip.generateAsync({ type: "blob" }).then(function (content) {
          saveAs(content, fileName + ".ggb");
        });
      }
    </script>
  </body>
</html>
